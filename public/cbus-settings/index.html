<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Stanfor2 - Cbus Settings</title>
    <!-- Font Icons -->
    <link media="all" rel="stylesheet" href="/configuration-interface/css/fonts/icomoon/icomoon.css">
    <link media="all" rel="stylesheet" href="/configuration-interface/css/fonts/roxine-font-icon/roxine-font.css">
    <link media="all" rel="stylesheet" href="/configuration-interface/vendors/font-awesome/css/font-awesome.css">
    <!-- Vendors -->
    <link media="all" rel="stylesheet" href="/configuration-interface/vendors/owl-carousel/dist/assets/owl.carousel.min.css">
    <link media="all" rel="stylesheet" href="/configuration-interface/vendors/owl-carousel/dist/assets/owl.theme.default.min.css">
    <link media="all" rel="stylesheet" href="/configuration-interface/vendors/animate/animate.css">
    <link media="all" rel="stylesheet" href="/configuration-interface/vendors/rateyo/jquery.rateyo.css">
    <link media="all" rel="stylesheet" href="/configuration-interface/vendors/bootstrap-datepicker/css/bootstrap-datepicker.css">
    <link media="all" rel="stylesheet" href="/configuration-interface/vendors/fancyBox/source/jquery.fancybox.css">
    <link media="all" rel="stylesheet" href="/configuration-interface/vendors/fancyBox/source/helpers/jquery.fancybox-thumbs.css">
    <!-- Bootstrap 4 -->
    <link media="all" rel="stylesheet" href="/configuration-interface/css/bootstrap.css">
    <!-- Rev Slider -->
    <link rel="stylesheet" type="text/css" href="/configuration-interface/vendors/rev-slider/revolution/css/settings.css">
    <link rel="stylesheet" type="text/css" href="/configuration-interface/vendors/rev-slider/revolution/css/layers.css">
    <link rel="stylesheet" type="text/css" href="/configuration-interface/vendors/rev-slider/revolution/css/navigation.css">
    <!-- Theme CSS -->
    <link media="all" rel="stylesheet" href="/configuration-interface/css/main.css">
</head>

<body>
    <!-- main wrapper -->
    <div id="wrapper">
        <div class="page-wrapper">
            <!-- header of the page -->
            <header class="fixed-top main-header header-white transparent" id="waituk-main-header">
                <div id="nav-section">
                    <div class="bottom-header container-fluid mega-menus" id="mega-menus">
                        <nav class="navbar navbar-toggleable-md no-border-radius no-margin mega-menu-multiple" id="navbar-inner-container">
                            <form action="mega-menu-5.html" id="top-search" class="no-margin top-search">
                                <div class="form-group no-margin">
                                    <input class="form-control no-border" id="search_term" name="search_term" placeholder="Type & Press Enter" type="text">
                                </div>
                            </form>
                            <button type="button" class="navbar-toggler navbar-toggler-left" data-toggle="collapse" data-target="#mega-menu">
                                <span class="navbar-toggler-icon"></span>
                            </button>
                            <!-- <a class="navbar-brand mr-auto m-sm-auto" href="index.html"> <img src="img/logo.svg" alt="roxine"> <img src="img/logo-dark.svg" alt="roxine"> </a> -->
                            <div class="collapse navbar-collapse flex-row-reverse" id="mega-menu">
                                <ul class="nav navbar-nav">
                                    <li>
                                        <a href="//stanfor2:8080"> Home </a>
                                    </li>
                                    <li>
                                        <a href="/viewer-settings"> Viewer Settings </a>
                                    </li>
                                    <li>
                                        <a href="/cbus-settings"> Cbus Settings </a>
                                    </li>
                                    <li>
                                        <a href="/system-info"> System Infomation </a>
                                    </li>
                                    <li>
                                        <a href=""> Logout </a>
                                    </li>
                                </ul>
                            </div>
                        </nav>
                    </div>
                </div>
            </header>
            <!--/header of the page -->
            <main>
                <!-- visual/banner of the page -->
                <section class="visual">
                    <div class="visual-inner visual-banner-v22 dark-overlay parallax" data-stellar-background-ratio="0.55">
                        <div class="container">
                            <div class="visual-text-large text-left visual-center">
                                <h1 class="visual-title visual-sub-title">C-bus Settings</h1>
                                <p>Update Cbus Settings so the API knows how to interface devices within your home.</p>
                                <div class="breadcrumb-block">
                                    <ol class="breadcrumb">
                                        <li class="breadcrumb-item"><a href="index.html"> Home </a></li>
                                        <li class="breadcrumb-item"><a href="index.html"> Settings </a></li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                <!--/visual/banner of the page -->
                <!-- main content wrapper -->
                <!-- main content wrapper -->
                <div class="content-wrapper" style="min-height: 60rem;">
                    <section class="content-block">
                        <div class="container">
                            <div class="demo-wrapper">
                                <div class="tab-container tab-center-container">
                                    <!-- Nav tabs -->
                                    <ul class="nav nav-tabs tab-text-nav" role="tablist">
                                        <li class="nav-item">
                                            <a class="nav-link active" data-toggle="tab" href="#tab4" role="tab">Controls</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" data-toggle="tab" href="#tab5" role="tab">Tasks</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" data-toggle="tab" href="#tab6" role="tab">Rules</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" data-toggle="tab" href="#tab7" role="tab">Scenes</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" data-toggle="tab" href="#tab8" role="tab">Devices</a>
                                        </li>
                                    </ul>
                                    <!-- Tab panes -->
                                    <div class="top-m-space tab-content">
                                        <div class="tab-pane fade show active" id="tab4" role="tabpanel">
                                            <!-- Cbus Controls -->
                                            <div class="container">
                                                <div class="row-fluid">
                                                    <div class="span12" id="content"></div>
                                                </div>
                                            </div>
                                            

                                        </div>
                                        <div class="tab-pane fade" id="tab5" role="tabpanel">
                                            <!-- Tasks Table -->
                                            <div id="tasks" class="data-table"></div>
                                            <br>
                                            <b><span class="icon-plus-circle" style="text-align: left" onclick="addNewItem('/configuration-interface/api/configuration/tasks')"> Add Task</span></b>
                                        </div>
                                        <div class="tab-pane fade" id="tab6" role="tabpanel">
                                            <!-- Rules Table -->
                                            <div id="rules" class="data-table"></div>
                                            <br>
                                            <b><span class="icon-plus-circle" style="text-align: left" onclick="addNewItem('/configuration-interface/api/configuration/rules')"> Add Rule</span></b>
                                        </div>
                                        <div class="tab-pane fade" id="tab7" role="tabpanel">
                                            <!-- Scenes Table -->
                                            <div id="scenes" class="data-table"></div>
                                            <br>
                                            <b><span class="icon-plus-circle" style="text-align: left" onclick="addNewItem('/configuration-interface/api/configuration/scenes')"> Add Scene</span></b>
                                        </div>
                                        <div class="tab-pane fade" id="tab8" role="tabpanel">
                                            <!-- Devices Table -->
                                            <div id="devices" class="data-table"></div>
                                            <br>
                                            <b><span class="icon-plus-circle" style="text-align: left" onclick="addNewItem('/configuration-interface/api/configuration/devices')"> Add Device</span></b>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>

                <!--/main content wrapper -->
            </main>
        </div>
        <!-- footer of the pagse -->
        <footer class="footer">
            <div class="footer-bottom text-center">
                <div class="container">
                    <p>Made with &#10084; by Jayden Downes &VerticalLine; Version: 1.3 </p>
                </div>
            </div>
        </footer>
        <!--/footer of the page -->
    </div>
    <!-- search form wrapper -->
    <div class="search-form-wrapper">
        <a href="#" class="nav-search-link close"><span class="icon-android-close"></span></a>
        <div class="holder">
            <input type="search" class="form-control form-control-v1" placeholder="Enter Your Search">
            <button type="submit"><span class="custom-icon-search"></span></button>
        </div>
    </div>
    <a href="#" class="section-scroll" id="scroll-to-top"><i class="fa fa-angle-up"></i></a>
    <!-- jquery library -->
    <script src="/configuration-interface/vendors/jquery/jquery-2.1.4.min.js"></script>
    <!-- external scripts -->
    <script src="/configuration-interface/vendors/tether/dist/js/tether.min.js"></script>
    <script src="/configuration-interface/vendors/bootstrap/js/bootstrap.min.js"></script>
    <script src="/configuration-interface/vendors/stellar/jquery.stellar.min.js"></script>
    <script src="/configuration-interface/vendors/isotope/javascripts/isotope.pkgd.min.js"></script>
    <script src="/configuration-interface/vendors/isotope/javascripts/packery-mode.pkgd.js"></script>
    <script src="/configuration-interface/vendors/owl-carousel/dist/owl.carousel.js"></script>
    <script src="/configuration-interface/vendors/waypoint/waypoints.min.js"></script>
    <script src="/configuration-interface/vendors/counter-up/jquery.counterup.min.js"></script>
    <script src="/configuration-interface/vendors/fancyBox/source/jquery.fancybox.pack.js"></script>
    <script src="/configuration-interface/vendors/fancyBox/source/helpers/jquery.fancybox-thumbs.js"></script>
    <script src="/configuration-interface/vendors/image-stretcher-master/image-stretcher.js"></script>
    <script src="/configuration-interface/vendors/wow/wow.min.js"></script>
    <script src="/configuration-interface/vendors/rateyo/jquery.rateyo.js"></script>
    <script src="/configuration-interface/vendors/bootstrap-datepicker/js/bootstrap-datepicker.js"></script>
    <script src="/configuration-interface/vendors/bootstrap-slider-master/src/js/bootstrap-slider.js"></script>
    <script src="/configuration-interface/vendors/bootstrap-select/dist/js/bootstrap-select.min.js"></script>
    <script src="/configuration-interface/js/mega-menu.js"></script>
    <!-- custom jquery script -->
    <script src="/configuration-interface/js/jquery.main.js"></script>
    <!-- Cbus Interface Files -->
    <script src="/light-interface/js/jquery.min.js" type="text/javascript">
	</script> 
	<script src="/light-interface/socket.io/socket.io.js">
	</script> 
	<script src="/light-interface/js/jquery.isotope.min.js">
	</script> 
	<script src="/light-interface/js/jquery.debounce.min.js">
	</script> 
	<script src="/light-interface/js/bootstrap.min.js">
	</script> 
	<script src="/light-interface/js/alertify.min.js">
	</script> 
	<script src="/light-interface/js/touchmove.js">
	</script> 
	<script src="/light-interface/js/cbus.js">
	</script>
    <!-- REVOLUTION JS FILES -->
    <script type="text/javascript" src="/configuration-interface/vendors/rev-slider/revolution/js/jquery.themepunch.tools.min.js"></script>
    <script type="text/javascript" src="/configuration-interface/vendors/rev-slider/revolution/js/jquery.themepunch.revolution.min.js"></script>
    <!-- SLIDER REVOLUTION 5.0 EXTENSIONS  (Load Extensions only on Local File Systems !  The following part can be removed on Server for On Demand Loading) -->
    <script type="text/javascript" src="/configuration-interface/vendors/rev-slider/revolution/js/extensions/revolution.extension.actions.min.js"></script>
    <script type="text/javascript" src="/configuration-interface/vendors/rev-slider/revolution/js/extensions/revolution.extension.carousel.min.js"></script>
    <script type="text/javascript" src="/configuration-interface/vendors/rev-slider/revolution/js/extensions/revolution.extension.kenburn.min.js"></script>
    <script type="text/javascript" src="/configuration-interface/vendors/rev-slider/revolution/js/extensions/revolution.extension.layeranimation.min.js"></script>
    <script type="text/javascript" src="/configuration-interface/vendors/rev-slider/revolution/js/extensions/revolution.extension.migration.min.js"></script>
    <script type="text/javascript" src="/configuration-interface/vendors/rev-slider/revolution/js/extensions/revolution.extension.navigation.min.js"></script>
    <script type="text/javascript" src="/configuration-interface/vendors/rev-slider/revolution/js/extensions/revolution.extension.parallax.min.js"></script>
    <script type="text/javascript" src="/configuration-interface/vendors/rev-slider/revolution/js/extensions/revolution.extension.slideanims.min.js"></script>
    <script type="text/javascript" src="/configuration-interface/vendors/rev-slider/revolution/js/extensions/revolution.extension.video.min.js"></script>
    <!-- SNOW ADD ON -->
    <script type="text/javascript" src="/configuration-interface/vendors/rev-slider/revolution-addons/snow/revolution.addon.snow.min.js"></script>
    <!-- revolutions slider script -->
    <script src="/configuration-interface/js/revolution.js"></script>
    <!-- CONFIGURATION Javascript Code -->
    <script>
function fetchAndDisplay(endpoint, containerId) {
    fetch(endpoint)
        .then(response => response.json())
        .then(data => {
            console.log(data); // Log the received data to the console

            // Get the key by removing the leading part of the endpoint string
            let key = endpoint.replace('/configuration-interface/api/configuration/', '');

            let items = data[key];
            if (!items) {
                console.log('No items found in data for endpoint ' + endpoint + '. This may be expected if no items have been created yet.');
                items = [];
            }

            // If it's devices, convert it into an array
            if (key === 'devices' && typeof items === "object") {
                items = Object.keys(items).map(id => ({id, ...items[id]}));
            }

            let html = `<table class="table"><thead><tr>`;

            // Get and display column headers
            if(items.length > 0){
                Object.keys(items[0]).forEach(property => {
                    html += `<th>${property.charAt(0).toUpperCase() + property.slice(1)}:</th>`;
                });
                html += `<th class="text-center">Actions:</th></tr></thead><tbody>`;
            }

            // Generate table rows with inputs
            items.forEach(item => {
                html += `<tr>`;
                Object.entries(item).forEach(([property, value]) => {
                    if (property === "enabled" || property === "visible") {
                        html += `<td><input type="checkbox" name="${property}" ${value ? 'checked' : ''}></td>`;
                    } else {
                        html += `<td><input type="text" name="${property}" value="${value}"></td>`;
                    }
                });

                // Actions column with icons
                html += `<td class="text-center">` +
                        `<span class="icon-check" onclick="updateItem('${endpoint}', '${item.id}')">&nbsp;</span>` +
                        `<span class="icon-cross" onclick="deleteItem('${endpoint}', '${item.id}')"></span>` +
                        `</td></tr>`;
            });

            html += `</tbody></table>`;
            document.getElementById(containerId).innerHTML = html;
        })
        .catch(error => {
            console.error("Error: ", error);
        });
}

    function addCommand(button) {
        const commandProperties = ['type', 'group', 'level', 'delay', 'timeout'];
        const newCommandIndex = button.parentNode.querySelectorAll('input[name^="commands["]').length / commandProperties.length;
        commandProperties.forEach(prop => {
            const commandInput = document.createElement('input');
            commandInput.name = `commands[${newCommandIndex}][${prop}]`;
            commandInput.value = prop === 'type' ? 'lighting' : 0;
            button.parentNode.insertBefore(commandInput, button);
            button.parentNode.insertBefore(document.createTextNode(prop + ': '), commandInput);
            button.parentNode.insertBefore(document.createElement('br'), commandInput.nextSibling);
        });
        button.parentNode.insertBefore(document.createElement('br'), button);
        button.parentNode.insertBefore(document.createElement('br'), button); // Extra line break
    }

    function updateItem(event, endpoint, id) {
        event.preventDefault();
        let formData = new FormData(event.target);
        let data = {};
        formData.forEach((value, key) => {
            if (key.includes('[')) {
                // Handle arrays
                let [property, index, arrayKey] = key.match(/(.+)\[(\d+)\]\[(.+)\]/).slice(1);
                if (!data[property]) {
                    data[property] = [];
                }
                if (!data[property][index]) {
                    data[property][index] = {};
                }
                data[property][index][arrayKey] = value;
            } else {
                // Handle regular fields
                data[key] = value;
            }
        });
        if (data.enabled !== undefined) {
            data.enabled = data.enabled === "on";
        }
        fetch(endpoint + '/' + id, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        }).then(response => {
            if (response.ok) {
                alert('Item updated successfully.');
                // Refresh the page
                location.reload();
            } else {
                alert('Error: ' + response.statusText);
            }
        });
    }

    function addNewItem(endpoint) {
        let newItem = {};
        switch (endpoint) {
            case '/configuration-interface/api/configuration/tasks':
                newItem = {
                    "enabled": true,
                    "name": "",
                    "cronstring": "",
                    "expression": "",
                    "commands": [{
                        "type": "",
                        "group": "",
                        "level": 0,
                        "delay": 0,
                        "timeout": 0
                    }]
                };
                break;
            case '/configuration-interface/api/configuration/rules':
                newItem = {
                    "enabled": true,
                    "name": "",
                    "expression": "",
                    "commands": [{
                        "type": "",
                        "group": "",
                        "level": 0,
                        "delay": 0,
                        "timeout": 0
                    }]
                };
                break;
            case '/configuration-interface/api/configuration/scenes':
                newItem = {
                    "name": "",
                    "commands": [{
                        "type": "",
                        "group": "",
                        "level": 0,
                        "delay": 0,
                        "timeout": 0
                    }]
                };
                break;
            case '/configuration-interface/api/configuration/devices':
                newItem = {
                    "name": "",
                    "location": "",
                    "level": 0,
                    "lastchange": null,
                    "type": "",
                    "visible": true,
                    "vendor": ""
                };
                break;
            default:
                return;
        }
        fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(newItem),
        }).then(response => {
            if (response.ok) {
                alert('Item added successfully.');
                // Refresh the page
                location.reload();
            } else {
                alert('Error: ' + response.statusText);
            }
        });
    }
    fetchAndDisplay('/configuration-interface/api/configuration/tasks', 'tasks');
    fetchAndDisplay('/configuration-interface/api/configuration/rules', 'rules');
    fetchAndDisplay('/configuration-interface/api/configuration/scenes', 'scenes');
    fetchAndDisplay('/configuration-interface/api/configuration/devices', 'devices');
    </script>
</body>

</html>
